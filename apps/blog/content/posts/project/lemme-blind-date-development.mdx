---
title: "Lemme Blind Date ì„œë¹„ìŠ¤ ê°œë°œê¸°"
description: "ì¹œêµ¬ì˜ ì¹œêµ¬ë¥¼ ì†Œê°œì‹œì¼œì£¼ëŠ” ë§¤ì¹­ ì„œë¹„ìŠ¤ë¥¼ Next.js, Supabase, Drizzle ORMìœ¼ë¡œ êµ¬í˜„í•œ ì´ì•¼ê¸°"
category: "project"
tags: ["nextjs", "supabase", "drizzle", "typescript", "i18n", "rls"]
createdAt: "2026-02-12"
updatedAt: "2026-02-12"
published: true
---

## ì •ë³´

URL: https://lemmeblinddate.com/

---

## ì™œ ë§Œë“¤ì—ˆë‚˜

ê¸°ì¡´ ë°ì´íŒ… ì•±ë“¤ì€ ëŒ€ë¶€ë¶„ ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜ ë§¤ì¹­ì„ ì œê³µí•©ë‹ˆë‹¤. í”„ë¡œí•„ ì‚¬ì§„ê³¼ ì§§ì€ ì†Œê°œê¸€ë§Œìœ¼ë¡œ ìƒëŒ€ë¥¼ íŒë‹¨í•´ì•¼ í•˜ê³ , ì‹¤ì œë¡œ ë§Œë‚˜ë³´ë©´ ê¸°ëŒ€ì™€ ë‹¤ë¥¸ ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.

ë°˜ë©´ ì§€ì¸ ì†Œê°œëŠ” ë‹¤ë¦…ë‹ˆë‹¤. ì†Œê°œí•´ì£¼ëŠ” ì‚¬ëŒì´ ì–‘ìª½ì„ ì•Œê³  ìˆìœ¼ë‹ˆ ì–´ëŠ ì •ë„ ê²€ì¦ì´ ë©ë‹ˆë‹¤. ë¬¸ì œëŠ” ì†Œê°œíŒ…ì„ ì£¼ì„ í•˜ë ¤ë©´ ì—°ë½ì²˜ë¥¼ ì£¼ê³ ë°›ê³ , ì‚¬ì§„ì„ ê³µìœ í•˜ê³ , ì¼ì •ì„ ì¡°ìœ¨í•˜ëŠ” ê³¼ì •ì´ ë²ˆê±°ë¡­ë‹¤ëŠ” ì ì…ë‹ˆë‹¤.

ì´ ì„œë¹„ìŠ¤ëŠ” ê·¸ ì¤‘ê°„ ì§€ì ì„ ë…¸ë ¸ìŠµë‹ˆë‹¤. ë°©ì¥ì´ "ë°©"ì„ ë§Œë“¤ê³  ì£¼ë³€ ì§€ì¸ë“¤ì˜ í”„ë¡œí•„ì„ ëª¨ìë‹ˆë‹¤. ê´€ì‹¬ ìˆëŠ” ì‚¬ëŒì´ í”„ë¡œí•„ì„ ë³´ê³  ë°©ì¥ì—ê²Œ ì§ì ‘ ì—°ë½í•´ì„œ ì†Œê°œë¥¼ ìš”ì²­í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤. ì•± ë‚´ ë§¤ì¹­ì´ë‚˜ ì±„íŒ… ê¸°ëŠ¥ì€ ì—†ìŠµë‹ˆë‹¤. ì†Œê°œíŒ…ì˜ ë³¸ì§ˆì¸ "ì§€ì¸ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ì—°ê²°"ì—ë§Œ ì§‘ì¤‘í–ˆìŠµë‹ˆë‹¤.

## ê°€ì„¤

Next.js App Routerì˜ ì„œë²„ ì»´í¬ë„ŒíŠ¸ì™€ Server Actionsë¥¼ í™œìš©í•˜ë©´ ë³„ë„ API ì„œë²„ ì—†ì´ í’€ìŠ¤íƒ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Supabaseì˜ Auth, PostgreSQL, RLSë¥¼ ì¡°í•©í•˜ë©´ ì¸ì¦ê³¼ ë°ì´í„° ë³´ì•ˆì„ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆì„ ê²ƒì´ë¼ ì˜ˆìƒí–ˆìŠµë‹ˆë‹¤.

```mermaid
flowchart TB
    subgraph Client["í´ë¼ì´ì–¸íŠ¸"]
        SC["Server Components<br/>(ë°ì´í„° ì¡°íšŒ)"]
        SA["Server Actions<br/>(ë°ì´í„° ë³€ê²½)"]
        CC["Client Components<br/>(ì¸í„°ë™ì…˜)"]
    end

    subgraph Supabase["Supabase"]
        Auth["Auth<br/>(Google OAuth)"]
        DB["PostgreSQL<br/>+ RLS"]
    end

    subgraph ORM["ë°ì´í„° ì ‘ê·¼"]
        Drizzle["Drizzle ORM"]
    end

    SC --> Drizzle
    SA --> Drizzle
    SA --> Auth
    Drizzle --> DB
    CC --> SA

    style Client fill:#E8F4FD
    style Supabase fill:#FFF8DC
    style ORM fill:#E8F8E8
```

## ê¸°ìˆ  ìŠ¤íƒ

| ì˜ì—­ | ê¸°ìˆ  | ì„ íƒ ì´ìœ  |
|---|---|---|
| í”„ë ˆì„ì›Œí¬ | Next.js 15 (App Router) | ì„œë²„ ì»´í¬ë„ŒíŠ¸, Server Actions |
| ìŠ¤íƒ€ì¼ë§ | Tailwind CSS | ëª¨ë°”ì¼ í¼ìŠ¤íŠ¸ ë°˜ì‘í˜• |
| ì¸ì¦ | Supabase Auth | Google OAuth, ì„¸ì…˜ ê´€ë¦¬ |
| ë°ì´í„°ë² ì´ìŠ¤ | Supabase PostgreSQL | RLS, ê´€ë¦¬í˜• ì„œë¹„ìŠ¤ |
| ORM | Drizzle ORM | íƒ€ì… ì•ˆì „, ê²½ëŸ‰ |
| ë‹¤êµ­ì–´ | next-intl | App Router ì§€ì› |
| ì´ë¯¸ì§€ | Cloudflare Images | Direct Upload |
| ë°°í¬ | Docker + Vercel | ì»¨í…Œì´ë„ˆí™” |

---

## Drizzle ORM ì„ íƒ ì´ìœ 

ORMì„ ì„ íƒí•  ë•Œ Prismaì™€ Drizzleì„ ë¹„êµí–ˆìŠµë‹ˆë‹¤.

### Prisma vs Drizzle ë¹„êµ

| í•­ëª© | Prisma | Drizzle |
|---|---|---|
| ë²ˆë“¤ í¬ê¸° | ë¬´ê±°ì›€ (Rust ì—”ì§„ í¬í•¨) | ê²½ëŸ‰ (ìˆœìˆ˜ TypeScript) |
| ìŠ¤í‚¤ë§ˆ ì •ì˜ | `.prisma` íŒŒì¼ (DSL) | TypeScript ì½”ë“œ |
| íƒ€ì… ìƒì„± | `prisma generate` í•„ìš” | ìŠ¤í‚¤ë§ˆì—ì„œ ìë™ ì¶”ë¡  |
| ë§ˆì´ê·¸ë ˆì´ì…˜ | `prisma migrate` | `drizzle-kit push/generate` |
| SQL ì¹œí™”ì„± | ì¶”ìƒí™” ë ˆë²¨ ë†’ìŒ | SQLì— ê°€ê¹Œìš´ API |

PrismaëŠ” ê°•ë ¥í•œ ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ë§Œ, ë³„ë„ì˜ ìŠ¤í‚¤ë§ˆ íŒŒì¼ê³¼ ì½”ë“œ ìƒì„± ë‹¨ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤. Drizzleì€ TypeScript ì½”ë“œë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•˜ê³ , íƒ€ì…ì´ ìë™ìœ¼ë¡œ ì¶”ë¡ ë©ë‹ˆë‹¤. ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ì—ì„œ ì½œë“œ ìŠ¤íƒ€íŠ¸ ì‹œê°„ë„ Drizzleì´ ìœ ë¦¬í•©ë‹ˆë‹¤.

### Drizzle ìŠ¤í‚¤ë§ˆ ì •ì˜

ìŠ¤í‚¤ë§ˆëŠ” TypeScriptë¡œ ì‘ì„±í•©ë‹ˆë‹¤. `pgTable` í•¨ìˆ˜ë¡œ í…Œì´ë¸”ì„ ì •ì˜í•˜ê³ , ì»¬ëŸ¼ íƒ€ì…ê³¼ ì œì•½ ì¡°ê±´ì„ ì§€ì •í•©ë‹ˆë‹¤.

```typescript
// db/schema.ts
import {
  pgTable,
  uuid,
  text,
  integer,
  jsonb,
  timestamp,
} from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";

export const users = pgTable("users", {
  id: uuid("id").primaryKey(),
  email: text("email").notNull(),
  name: text("name"),
  role: text("role", { enum: ["user", "admin"] }).default("user").notNull(),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
});

export const rooms = pgTable("rooms", {
  id: uuid("id").primaryKey().defaultRandom(),
  name: text("name").notNull(),
  passwordHash: text("password_hash").notNull(),
  slug: text("slug").notNull().unique(),
  creatorId: uuid("creator_id").notNull().references(() => users.id),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow().notNull(),
});

export const profiles = pgTable("profiles", {
  id: uuid("id").primaryKey().defaultRandom(),
  roomId: uuid("room_id").notNull().references(() => rooms.id, { onDelete: "cascade" }),
  userId: uuid("user_id").notNull().references(() => users.id),
  name: text("name").notNull(),
  gender: text("gender", { enum: ["male", "female"] }).notNull(),
  photos: jsonb("photos").$type<string[]>().default([]),
  // ... ê¸°íƒ€ í•„ë“œ
});
```

`$type<T>()`ë¥¼ ì‚¬ìš©í•˜ë©´ JSONB ì»¬ëŸ¼ì˜ íƒ€ì…ì„ ëª…ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `photos` í•„ë“œëŠ” `string[]` íƒ€ì…ìœ¼ë¡œ ì¶”ë¡ ë©ë‹ˆë‹¤.

### ê´€ê³„ ì •ì˜

Drizzleì˜ `relations` í•¨ìˆ˜ë¡œ í…Œì´ë¸” ê°„ ê´€ê³„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì´ ê´€ê³„ëŠ” ì¿¼ë¦¬ ì‹œ ìë™ ì¡°ì¸ì— í™œìš©ë©ë‹ˆë‹¤.

```typescript
export const roomsRelations = relations(rooms, ({ one, many }) => ({
  creator: one(users, { fields: [rooms.creatorId], references: [users.id] }),
  profiles: many(profiles),
}));

export const profilesRelations = relations(profiles, ({ one }) => ({
  room: one(rooms, { fields: [profiles.roomId], references: [rooms.id] }),
  user: one(users, { fields: [profiles.userId], references: [users.id] }),
}));
```


### íƒ€ì… ì¶”ë¡ 

ìŠ¤í‚¤ë§ˆì—ì„œ íƒ€ì…ì„ ìë™ìœ¼ë¡œ ì¶”ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Prismaì²˜ëŸ¼ ë³„ë„ì˜ generate ëª…ë ¹ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.

```typescript
// ìŠ¤í‚¤ë§ˆì—ì„œ íƒ€ì… ì¶”ë¡ 
export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;
export type Room = typeof rooms.$inferSelect;
export type Profile = typeof profiles.$inferSelect;
```

### db push vs migration

Drizzle Kitì€ ë‘ ê°€ì§€ ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ë°©ì‹ì„ ì œê³µí•©ë‹ˆë‹¤.

```mermaid
flowchart LR
    subgraph ê°œë°œ["ê°œë°œ í™˜ê²½"]
        PUSH["drizzle-kit push<br/>(ì¦‰ì‹œ ë°˜ì˜)"]
    end

    subgraph ìš´ì˜["ìš´ì˜ í™˜ê²½"]
        GEN["drizzle-kit generate<br/>(SQL íŒŒì¼ ìƒì„±)"]
        MIG["drizzle-kit migrate<br/>(ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰)"]
    end

    SCHEMA["schema.ts"] --> PUSH
    SCHEMA --> GEN --> MIG

    style ê°œë°œ fill:#E8F4FD
    style ìš´ì˜ fill:#FFF8DC
```

`db push`ëŠ” ìŠ¤í‚¤ë§ˆ ë³€ê²½ì„ ì¦‰ì‹œ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•©ë‹ˆë‹¤. ê°œë°œ ì¤‘ ë¹ ë¥¸ ì´í„°ë ˆì´ì…˜ì— ìœ ìš©í•©ë‹ˆë‹¤. ìš´ì˜ í™˜ê²½ì—ì„œëŠ” `generate`ë¡œ SQL ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ìƒì„±í•˜ê³ , `migrate`ë¡œ ì ìš©í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.

```bash
# ê°œë°œ: ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì¦‰ì‹œ ë°˜ì˜
pnpm drizzle-kit push

# ìš´ì˜: ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„± í›„ ì ìš©
pnpm drizzle-kit generate
pnpm drizzle-kit migrate
```

### Drizzle ì„¤ì •

`drizzle.config.ts`ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ê³¼ ìŠ¤í‚¤ë§ˆ ê²½ë¡œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

```typescript
// drizzle.config.ts
import { config } from "dotenv";
import { defineConfig } from "drizzle-kit";

config({ path: ".env.local" });

export default defineConfig({
  schema: "./db/schema.ts",
  out: "./drizzle",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
  verbose: true,
  strict: true,
});
```

---

## Next.js ì„œë²„ ì»´í¬ë„ŒíŠ¸ í™œìš©

App Routerì˜ ì„œë²„ ì»´í¬ë„ŒíŠ¸ëŠ” ê¸°ë³¸ê°’ì…ë‹ˆë‹¤. ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§ì ‘ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


### ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë°ì´í„° ì¡°íšŒ

ë³„ë„ì˜ API ì—”ë“œí¬ì¸íŠ¸ ì—†ì´ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§ì ‘ DBë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

```typescript
// app/[locale]/rooms/[slug]/page.tsx
import { notFound } from "next/navigation";
import { getRoom, getProfilesByRoom } from "@/lib/cache";
import { createClient } from "@/lib/supabase/server";

export default async function RoomPage({ params }: { params: Promise<{ slug: string }> }) {
  const { slug } = await params;
  const room = await getRoom(slug);

  if (!room) {
    notFound();
  }

  const profileList = await getProfilesByRoom(room.id);

  // í˜„ì¬ ì‚¬ìš©ìê°€ ë°©ì¥ì¸ì§€ í™•ì¸
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  const isCreator = user?.id === room.creatorId;

  return (
    <RoomContent
      profiles={profileList}
      slug={slug}
      roomName={room.name}
      isCreator={isCreator}
    />
  );
}
```

`async/await`ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³ , ì¡°ê±´ì— ë”°ë¼ ë‹¤ë¥¸ UIë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ì— ë¶ˆí•„ìš”í•œ ë°ì´í„°ê°€ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### ë§ˆì´ í˜ì´ì§€ ì˜ˆì‹œ

ì‚¬ìš©ìë³„ ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ì¡°íšŒí•˜ê³  ë Œë”ë§í•©ë‹ˆë‹¤.

```typescript
// app/[locale]/my/page.tsx
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";
import { getUserRoomCount, getUserProfileCount } from "@/lib/cache";

export default async function MyPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login?from=/my");
  }

  const [roomCount, profileCount] = await Promise.all([
    getUserRoomCount(user.id),
    getUserProfileCount(user.id),
  ]);

  return (
    <div>
      <h1>{user.user_metadata?.full_name}</h1>
      <p>ìƒì„±í•œ ë°©: {roomCount}ê°œ</p>
      <p>ë“±ë¡í•œ í”„ë¡œí•„: {profileCount}ê°œ</p>
    </div>
  );
}
```

`Promise.all`ë¡œ ë³‘ë ¬ ì¡°íšŒí•˜ì—¬ ì‘ë‹µ ì‹œê°„ì„ ë‹¨ì¶•í•©ë‹ˆë‹¤.

---

## Server Actionsë¡œ ë°ì´í„° ë³€ê²½

Server ActionsëŠ” í¼ ì œì¶œê³¼ ë°ì´í„° ë³€ê²½ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. `'use server'` ì§€ì‹œì–´ë¡œ ì„œë²„ì—ì„œë§Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.


### Server Action êµ¬ì¡°

```typescript
// actions/rooms.ts
"use server";

import { eq, count } from "drizzle-orm";
import { nanoid } from "nanoid";
import { db, rooms, users } from "@/db";
import { createClient } from "@/lib/supabase/server";
import { createRoomSchema } from "@/lib/validations";
import { invalidateOnRoomChange } from "@/lib/cache";

export type ActionResult<T = void> = 
  | { success: true; data: T }
  | { success: false; error: string };

export async function createRoom(formData: FormData): Promise<ActionResult<{ slug: string }>> {
  // 1. ì¸ì¦ í™•ì¸
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { success: false, error: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤" };
  }

  // 2. ì…ë ¥ê°’ íŒŒì‹± ë° ê²€ì¦
  const rawData = {
    name: formData.get("name") as string,
    password: formData.get("password") as string,
  };

  const parsed = createRoomSchema.safeParse(rawData);
  if (!parsed.success) {
    const errors = parsed.error.flatten().fieldErrors;
    const firstError = Object.values(errors).flat()[0];
    return { success: false, error: firstError || "ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”" };
  }

  // 3. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ë°© ê°œìˆ˜ ì œí•œ)
  const [existingRoomCount] = await db
    .select({ count: count() })
    .from(rooms)
    .where(eq(rooms.creatorId, user.id));

  if (existingRoomCount.count >= 1) {
    return { success: false, error: "ê³„ì •ë‹¹ 1ê°œì˜ ë°©ë§Œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤" };
  }

  // 4. ë°ì´í„° ì €ì¥
  const slug = nanoid(10);
  const [newRoom] = await db
    .insert(rooms)
    .values({
      name: parsed.data.name,
      passwordHash: parsed.data.password,
      slug,
      creatorId: user.id,
    })
    .returning();

  // 5. ìºì‹œ ë¬´íš¨í™”
  await invalidateOnRoomChange();

  return { success: true, data: { slug: newRoom.slug } };
}
```

Server Actionì˜ ì¼ë°˜ì ì¸ íë¦„ì…ë‹ˆë‹¤. ì¸ì¦ í™•ì¸ â†’ Zod ê²€ì¦ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ â†’ DB ì €ì¥ â†’ ìºì‹œ ë¬´íš¨í™” ìˆœì„œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.

### í´ë¼ì´ì–¸íŠ¸ì—ì„œ Server Action í˜¸ì¶œ

```typescript
// í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ í¼ ì œì¶œ
"use client";

import { useActionState } from "react";
import { createRoom } from "@/actions/rooms";

export function CreateRoomForm() {
  const [state, formAction, isPending] = useActionState(createRoom, null);

  return (
    <form action={formAction}>
      <input name="name" placeholder="ë°© ì´ë¦„" required />
      <input name="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required />
      <button type="submit" disabled={isPending}>
        {isPending ? "ìƒì„± ì¤‘..." : "ë°© ë§Œë“¤ê¸°"}
      </button>
      {state?.error && <p className="text-red-500">{state.error}</p>}
    </form>
  );
}
```

`useActionState` í›…ìœ¼ë¡œ Server Actionì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ë¡œë”© ìƒíƒœì™€ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì‰½ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## Supabase í™œìš©


SupabaseëŠ” Auth, PostgreSQL, Storageë¥¼ í†µí•© ì œê³µí•˜ëŠ” BaaSì…ë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” Authì™€ PostgreSQLì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

### Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •

Next.js App Routerì—ì„œëŠ” ì„œë²„/í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
// lib/supabase/server.ts - Server Components, Server Actionsìš©
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // Server Componentì—ì„œ í˜¸ì¶œëœ ê²½ìš° ë¬´ì‹œ
          }
        },
      },
    }
  );
}
```

```typescript
// lib/supabase/client.ts - Client Componentsìš©
"use client";

import { createBrowserClient } from "@supabase/ssr";

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}
```

`@supabase/ssr` íŒ¨í‚¤ì§€ëŠ” ì¿ í‚¤ ê¸°ë°˜ ì„¸ì…˜ ê´€ë¦¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì„œë²„ì—ì„œëŠ” `cookies()` APIë¡œ ì¿ í‚¤ë¥¼ ì½ê³  ì”ë‹ˆë‹¤.

### Google OAuth ì¸ì¦

Supabase Authë¡œ Google ë¡œê·¸ì¸ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

```typescript
// ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ
const supabase = createClient();
await supabase.auth.signInWithOAuth({
  provider: "google",
  options: {
    redirectTo: `${window.location.origin}/auth/callback`,
  },
});
```

OAuth ì½œë°±ì—ì„œ ì„¸ì…˜ì„ êµí™˜í•©ë‹ˆë‹¤.

```typescript
// app/auth/callback/route.ts
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get("code");
  const next = searchParams.get("next") ?? "/";

  if (code) {
    const supabase = await createClient();
    const { error } = await supabase.auth.exchangeCodeForSession(code);
    if (!error) {
      return NextResponse.redirect(`${origin}${next}`);
    }
  }

  return NextResponse.redirect(`${origin}/login?error=auth_failed`);
}
```

---

## Supabase RLS (Row Level Security)

RLSëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì¤€ì—ì„œ í–‰ ë‹¨ìœ„ ì ‘ê·¼ ì œì–´ë¥¼ ì ìš©í•©ë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì—ì„œ ê¶Œí•œ ê²€ì‚¬ë¥¼ ëˆ„ë½í•´ë„ DBì—ì„œ ì°¨ë‹¨ë©ë‹ˆë‹¤.


### RLS ë™ì‘ ì›ë¦¬

```mermaid
flowchart TB
    subgraph ìš”ì²­["í´ë¼ì´ì–¸íŠ¸ ìš”ì²­"]
        REQ["SELECT * FROM profiles<br/>WHERE room_id = 'xxx'"]
    end

    subgraph RLS["RLS ì •ì±… í‰ê°€"]
        POLICY["profiles_select_public<br/>USING (true)"]
    end

    subgraph ê²°ê³¼["ì¿¼ë¦¬ ê²°ê³¼"]
        DATA["ëª¨ë“  í”„ë¡œí•„ ë°˜í™˜<br/>(ê³µê°œ ì¡°íšŒ í—ˆìš©)"]
    end

    REQ --> RLS --> DATA

    style ìš”ì²­ fill:#E8F4FD
    style RLS fill:#FFF8DC
    style ê²°ê³¼ fill:#E8F8E8
```

RLS ì •ì±…ì€ ê° í–‰ì— ëŒ€í•´ `USING` ì ˆì˜ ì¡°ê±´ì„ í‰ê°€í•©ë‹ˆë‹¤. ì¡°ê±´ì´ `true`ì¸ í–‰ë§Œ ê²°ê³¼ì— í¬í•¨ë©ë‹ˆë‹¤.

### RLS ì •ì±… ì„¤ê³„

ì´ ì„œë¹„ìŠ¤ì˜ ì ‘ê·¼ ì œì–´ ìš”êµ¬ì‚¬í•­ì…ë‹ˆë‹¤.

| í…Œì´ë¸” | SELECT | INSERT | UPDATE | DELETE |
|---|---|---|---|---|
| rooms | ëª¨ë‘ í—ˆìš© | ë¡œê·¸ì¸ ì‚¬ìš©ì | ë°©ì¥ë§Œ | ë°©ì¥ë§Œ |
| profiles | ëª¨ë‘ í—ˆìš© | ë¡œê·¸ì¸ ì‚¬ìš©ì | ë³¸ì¸ ë˜ëŠ” ë°©ì¥ | ë³¸ì¸ ë˜ëŠ” ë°©ì¥ |

SQLë¡œ ì •ì±…ì„ ì •ì˜í•©ë‹ˆë‹¤.

```sql
-- rooms í…Œì´ë¸” RLS
ALTER TABLE rooms ENABLE ROW LEVEL SECURITY;

-- ëª¨ë“  ì‚¬ìš©ìê°€ ë°© ì¡°íšŒ ê°€ëŠ¥ (ë¹„ë¡œê·¸ì¸ í¬í•¨)
CREATE POLICY "rooms_select_public" ON rooms
  FOR SELECT USING (true);

-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ë°© ìƒì„± ê°€ëŠ¥
CREATE POLICY "rooms_insert_auth" ON rooms
  FOR INSERT WITH CHECK (auth.uid() = creator_id);

-- ë°©ì¥ë§Œ ìì‹ ì˜ ë°© ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "rooms_update_owner" ON rooms
  FOR UPDATE USING (auth.uid() = creator_id);

-- ë°©ì¥ë§Œ ìì‹ ì˜ ë°© ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "rooms_delete_owner" ON rooms
  FOR DELETE USING (auth.uid() = creator_id);
```

`auth.uid()`ëŠ” Supabaseê°€ ì œê³µí•˜ëŠ” í•¨ìˆ˜ë¡œ, í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ìì˜ IDë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

### ë³µì¡í•œ ì •ì±…: ë³¸ì¸ ë˜ëŠ” ë°©ì¥

í”„ë¡œí•„ ìˆ˜ì •/ì‚­ì œëŠ” ë“±ë¡ì ë³¸ì¸ ë˜ëŠ” ë°©ì¥ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì„œë¸Œì¿¼ë¦¬ë¡œ ë°©ì¥ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

```sql
-- ë“±ë¡ì ë³¸ì¸ ë˜ëŠ” ë°©ì¥ë§Œ í”„ë¡œí•„ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "profiles_update_owner_or_admin" ON profiles
  FOR UPDATE USING (
    auth.uid() = user_id
    OR auth.uid() = (SELECT creator_id FROM rooms WHERE id = room_id)
  );

-- ë“±ë¡ì ë³¸ì¸ ë˜ëŠ” ë°©ì¥ë§Œ í”„ë¡œí•„ ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "profiles_delete_owner_or_admin" ON profiles
  FOR DELETE USING (
    auth.uid() = user_id
    OR auth.uid() = (SELECT creator_id FROM rooms WHERE id = room_id)
  );
```

### RLSì™€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì˜ ì´ì¤‘ ê²€ì¦

RLSê°€ ìˆì–´ë„ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê¶Œí•œ ê²€ì‚¬ë¥¼ í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ì œê³µí•  ìˆ˜ ìˆê³ , RLS ì •ì±… ë³€ê²½ ì‹œ ì˜í–¥ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.

```typescript
// actions/profiles.ts
export async function updateProfile(profileId: string, formData: FormData) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { success: false, error: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤" };
  }

  // í”„ë¡œí•„ ì¡°íšŒ
  const [profile] = await db
    .select({ userId: profiles.userId, roomId: profiles.roomId })
    .from(profiles)
    .where(eq(profiles.id, profileId));

  // ë°©ì¥ í™•ì¸
  const [room] = await db
    .select({ creatorId: rooms.creatorId })
    .from(rooms)
    .where(eq(rooms.id, profile.roomId));

  // ê¶Œí•œ í™•ì¸: ë“±ë¡ì ë³¸ì¸ ë˜ëŠ” ë°©ì¥
  const isOwner = profile.userId === user.id;
  const isRoomCreator = room?.creatorId === user.id;

  if (!isOwner && !isRoomCreator) {
    return { success: false, error: "ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤" };
  }

  // ... ìˆ˜ì • ë¡œì§
}
```

---

## Next.js ìºì‹± ì „ëµ


Next.js App RouterëŠ” ì—¬ëŸ¬ ë ˆë²¨ì˜ ìºì‹±ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” React `cache()`ì™€ `unstable_cache()`ë¥¼ ì¡°í•©í•´ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.

### ìºì‹± ë ˆì´ì–´ êµ¬ì¡°

```mermaid
flowchart TB
    subgraph ìš”ì²­["ë‹¨ì¼ ìš”ì²­"]
        RC["React cache()<br/>(ìš”ì²­ ë‚´ ì¤‘ë³µ ë°©ì§€)"]
    end

    subgraph ì„œë²„["ì„œë²„ ìºì‹œ"]
        UC["unstable_cache()<br/>(ì‹œê°„ ê¸°ë°˜ + íƒœê·¸)"]
    end

    subgraph DB["ë°ì´í„°ë² ì´ìŠ¤"]
        PG["PostgreSQL"]
    end

    RC --> UC --> PG

    style ìš”ì²­ fill:#E8F4FD
    style ì„œë²„ fill:#FFF8DC
    style DB fill:#E8F8E8
```

### React cache() - ìš”ì²­ ë‚´ ì¤‘ë³µ ë°©ì§€

ë™ì¼í•œ ìš”ì²­ ë‚´ì—ì„œ ê°™ì€ í•¨ìˆ˜ë¥¼ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•´ë„ í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.

```typescript
// lib/cache/rooms.ts
import { cache } from "react";

export const getRoom = cache(async (slug: string) => {
  return getCachedRoom(slug);
});
```

ì˜ˆë¥¼ ë“¤ì–´ ë ˆì´ì•„ì›ƒê³¼ í˜ì´ì§€ì—ì„œ ëª¨ë‘ `getRoom(slug)`ë¥¼ í˜¸ì¶œí•´ë„ DB ì¿¼ë¦¬ëŠ” í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.

### unstable_cache() - ì‹œê°„ ê¸°ë°˜ ìºì‹±

`unstable_cache()`ëŠ” ê²°ê³¼ë¥¼ ì„œë²„ì— ìºì‹±í•˜ê³ , ì§€ì •ëœ ì‹œê°„ì´ ì§€ë‚˜ë©´ ì¬ê²€ì¦í•©ë‹ˆë‹¤.

```typescript
import { unstable_cache } from "next/cache";

const getCachedRoom = unstable_cache(
  async (slug: string) => {
    const [room] = await db
      .select({
        id: rooms.id,
        name: rooms.name,
        slug: rooms.slug,
        creatorId: rooms.creatorId,
      })
      .from(rooms)
      .where(eq(rooms.slug, slug));

    return room || null;
  },
  ["room-by-slug"],           // ìºì‹œ í‚¤
  { revalidate: 60, tags: ["rooms"] }  // 60ì´ˆ í›„ ì¬ê²€ì¦, íƒœê·¸ë¡œ ë¬´íš¨í™”
);
```

### íƒœê·¸ ê¸°ë°˜ ìºì‹œ ë¬´íš¨í™”

ë°ì´í„°ê°€ ë³€ê²½ë˜ë©´ ê´€ë ¨ ìºì‹œë¥¼ ë¬´íš¨í™”í•©ë‹ˆë‹¤.

```typescript
// lib/cache/invalidate.ts
"use server";

import { revalidateTag } from "next/cache";

// ë°© ìƒì„±/ìˆ˜ì •/ì‚­ì œ ì‹œ í˜¸ì¶œ
export async function invalidateOnRoomChange() {
  revalidateTag("rooms", { expire: 0 });
  revalidateTag("user-rooms", { expire: 0 });
}

// í”„ë¡œí•„ ìƒì„±/ìˆ˜ì •/ì‚­ì œ ì‹œ í˜¸ì¶œ
export async function invalidateOnProfileChange() {
  revalidateTag("profiles", { expire: 0 });
  revalidateTag("user-profiles", { expire: 0 });
}
```

Server Actionì—ì„œ ë°ì´í„° ë³€ê²½ í›„ ìºì‹œë¥¼ ë¬´íš¨í™”í•©ë‹ˆë‹¤.

```typescript
// actions/rooms.ts
export async function createRoom(formData: FormData) {
  // ... ë°© ìƒì„± ë¡œì§

  // ìºì‹œ ë¬´íš¨í™”
  await invalidateOnRoomChange();

  return { success: true, data: { slug: newRoom.slug } };
}
```

### ìºì‹œ í•¨ìˆ˜ ì¡°í•©

ë‘ ìºì‹œë¥¼ ì¡°í•©í•˜ë©´ ìš”ì²­ ë‚´ ì¤‘ë³µ ë°©ì§€ì™€ ì„œë²„ ìºì‹±ì„ ëª¨ë‘ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript
// lib/cache/profiles.ts
import { cache } from "react";
import { unstable_cache } from "next/cache";

// ì™¸ë¶€ì— ë…¸ì¶œë˜ëŠ” í•¨ìˆ˜ - React cacheë¡œ ë˜í•‘
export const getProfilesByRoom = cache(async (roomId: string) => {
  return getCachedProfilesByRoom(roomId);
});

// ë‚´ë¶€ í•¨ìˆ˜ - unstable_cacheë¡œ ì„œë²„ ìºì‹±
const getCachedProfilesByRoom = unstable_cache(
  async (roomId: string) => {
    return db
      .select({
        id: profiles.id,
        name: profiles.name,
        gender: profiles.gender,
        photos: profiles.photos,
      })
      .from(profiles)
      .where(eq(profiles.roomId, roomId));
  },
  ["profiles-by-room"],
  { revalidate: 30, tags: ["profiles"] }
);
```

---

## i18n ë‹¤êµ­ì–´ ì§€ì›


next-intlì„ ì‚¬ìš©í•´ì„œ í•œêµ­ì–´/ì˜ì–´ ë‹¤êµ­ì–´ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. IP ì£¼ì†Œ ê¸°ë°˜ìœ¼ë¡œ ê¸°ë³¸ ì–¸ì–´ë¥¼ ìë™ ì„¤ì •í•˜ëŠ” ê¸°ëŠ¥ë„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### ë¼ìš°íŒ… ì„¤ì •

```typescript
// i18n/routing.ts
import { defineRouting } from "next-intl/routing";

export const routing = defineRouting({
  locales: ["ko", "en"],
  defaultLocale: "en",
  localePrefix: "as-needed", // ê¸°ë³¸ ë¡œì¼€ì¼(en)ì€ URLì— prefix ì—†ìŒ
});
```

`localePrefix: "as-needed"` ì„¤ì •ìœ¼ë¡œ ê¸°ë³¸ ë¡œì¼€ì¼(ì˜ì–´)ì€ `/rooms/abc` í˜•íƒœë¡œ, í•œêµ­ì–´ëŠ” `/ko/rooms/abc` í˜•íƒœë¡œ URLì´ êµ¬ì„±ë©ë‹ˆë‹¤.

### IP ê¸°ë°˜ ë¡œì¼€ì¼ ê°ì§€

ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì‚¬ìš©ìì˜ IP ì£¼ì†Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ êµ­ê°€ë¥¼ ê°ì§€í•˜ê³ , í•œêµ­ì´ë©´ í•œêµ­ì–´ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

```typescript
// middleware.ts
function detectLocale(request: NextRequest): string {
  // 1ìˆœìœ„: ì‚¬ìš©ìê°€ ì§ì ‘ ì„¤ì •í•œ ì–¸ì–´ ì„ í˜¸
  const userPreference = request.cookies.get("user-locale-preference")?.value;
  if (userPreference && locales.includes(userPreference)) {
    return userPreference;
  }

  // 2ìˆœìœ„: IP ê¸°ë°˜ ì§€ì—­ ê°ì§€ (Vercel, Cloudflare ë“±ì—ì„œ ì œê³µ)
  const country =
    request.headers.get("x-vercel-ip-country") ||
    request.headers.get("cf-ipcountry");
  if (country === "KR") {
    return "ko";
  }

  // 3ìˆœìœ„: ê¸°ë³¸ê°’ ì˜ì–´
  return "en";
}
```

Vercelì€ `x-vercel-ip-country`, CloudflareëŠ” `cf-ipcountry` í—¤ë”ë¡œ êµ­ê°€ ì½”ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.

### ë¡œì¼€ì¼ ê°ì§€ íë¦„

```mermaid
flowchart TB
    REQ["ìš”ì²­ ìˆ˜ì‹ "] --> CHECK1{"URLì— ë¡œì¼€ì¼<br/>ì ‘ë‘ì‚¬ ìˆìŒ?"}
    
    CHECK1 -->|"/ko/..."| USE_PATH["URL ë¡œì¼€ì¼ ì‚¬ìš©"]
    CHECK1 -->|"/"| DETECT["ë¡œì¼€ì¼ ê°ì§€"]
    
    DETECT --> PREF{"ì‚¬ìš©ì ì„ í˜¸<br/>ì¿ í‚¤ ìˆìŒ?"}
    PREF -->|"ìˆìŒ"| USE_PREF["ì¿ í‚¤ ë¡œì¼€ì¼ ì‚¬ìš©"]
    PREF -->|"ì—†ìŒ"| IP{"IP êµ­ê°€ê°€<br/>KR?"}
    
    IP -->|"KR"| REDIRECT_KO["â†’ /ko/... ë¦¬ë‹¤ì´ë ‰íŠ¸"]
    IP -->|"ê¸°íƒ€"| USE_EN["ì˜ì–´ (rewrite)"]

    style REQ fill:#E8F4FD
    style DETECT fill:#FFF8DC
```

### ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„

```typescript
// middleware.ts
export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  const pathLocale = getPathLocale(pathname);

  // URLì— ê¸°ë³¸ ë¡œì¼€ì¼ ì ‘ë‘ì‚¬ê°€ ìˆìœ¼ë©´ ì œê±° (/en/... â†’ /...)
  if (pathLocale === defaultLocale) {
    const url = request.nextUrl.clone();
    url.pathname = stripLocalePrefix(pathname);
    return NextResponse.redirect(url);
  }

  // URLì— ë¹„ê¸°ë³¸ ë¡œì¼€ì¼ ì ‘ë‘ì‚¬ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì§„í–‰ (/ko/...)
  if (pathLocale) {
    request.cookies.set("NEXT_LOCALE", pathLocale);
    return updateSession(request);
  }

  // URLì— ë¡œì¼€ì¼ ì ‘ë‘ì‚¬ê°€ ì—†ìœ¼ë©´ ê°ì§€
  const detectedLocale = detectLocale(request);

  // ë¹„ê¸°ë³¸ ë¡œì¼€ì¼ì´ ê°ì§€ë˜ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸
  if (detectedLocale !== defaultLocale) {
    const url = request.nextUrl.clone();
    url.pathname = `/${detectedLocale}${pathname}`;
    return NextResponse.redirect(url);
  }

  // ê¸°ë³¸ ë¡œì¼€ì¼: rewriteë¡œ [locale] ì„¸ê·¸ë¨¼íŠ¸ ì„¤ì •
  const url = request.nextUrl.clone();
  url.pathname = `/${defaultLocale}${pathname}`;
  return NextResponse.rewrite(url);
}
```

### ì–¸ì–´ ì „í™˜ ì»´í¬ë„ŒíŠ¸

ì‚¬ìš©ìê°€ ì–¸ì–´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•˜ë©´ ì¿ í‚¤ì— ì €ì¥í•©ë‹ˆë‹¤.

```typescript
// components/LocaleSwitcher.tsx
"use client";

import { useRouter, usePathname } from "next/navigation";
import Cookies from "js-cookie";

export function LocaleSwitcher() {
  const router = useRouter();
  const pathname = usePathname();

  const switchLocale = (newLocale: string) => {
    // ì‚¬ìš©ì ì„ í˜¸ ì €ì¥
    Cookies.set("user-locale-preference", newLocale, { expires: 365 });
    
    // ìƒˆ ë¡œì¼€ì¼ë¡œ ì´ë™
    const newPath = newLocale === "en" 
      ? pathname.replace(/^\/ko/, "") 
      : `/ko${pathname}`;
    router.push(newPath);
  };

  return (
    <button onClick={() => switchLocale(/* í† ê¸€ */)}>
      ğŸŒ
    </button>
  );
}
```

---

## ê¸°íƒ€ ê¸°ìˆ ì  í¬ì¸íŠ¸


### Cloudflare Images Direct Upload

ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” ì„œë²„ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ Cloudflareë¡œ ì§ì ‘ ì „ì†¡í•©ë‹ˆë‹¤. ì„œë²„ ë¶€í•˜ë¥¼ ì¤„ì´ê³  ì—…ë¡œë“œ ì†ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant C as í´ë¼ì´ì–¸íŠ¸
    participant S as ì„œë²„ (Server Action)
    participant CF as Cloudflare Images

    C->>S: ì—…ë¡œë“œ URL ìš”ì²­
    S->>CF: Direct Upload URL ë°œê¸‰ ìš”ì²­
    CF-->>S: uploadUrl, imageId ë°˜í™˜
    S-->>C: uploadUrl ì „ë‹¬
    C->>CF: ì´ë¯¸ì§€ ì§ì ‘ ì—…ë¡œë“œ
    CF-->>C: ì—…ë¡œë“œ ì™„ë£Œ, ì´ë¯¸ì§€ URL ë°˜í™˜
    C->>S: í”„ë¡œí•„ ì €ì¥ (ì´ë¯¸ì§€ URL í¬í•¨)
```

```typescript
// actions/images.ts
export async function getDirectUploadUrl(): Promise<ActionResult<{ uploadUrl: string; imageId: string }>> {
  const response = await fetch(
    `https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/images/v2/direct_upload`,
    {
      method: "POST",
      headers: {
        Authorization: `Bearer ${CLOUDFLARE_API_TOKEN}`,
      },
    }
  );

  const data = await response.json();
  return {
    success: true,
    data: {
      uploadUrl: data.result.uploadURL,
      imageId: data.result.id,
    },
  };
}
```

### Zod ìŠ¤í‚¤ë§ˆ ê²€ì¦

ëª¨ë“  ì…ë ¥ê°’ì€ Zodë¡œ ê²€ì¦í•©ë‹ˆë‹¤. íƒ€ì… ì•ˆì „ì„±ê³¼ ëŸ°íƒ€ì„ ê²€ì¦ì„ ë™ì‹œì— í™•ë³´í•©ë‹ˆë‹¤.

```typescript
// lib/validations/profile.ts
import { z } from "zod";

export const createProfileSchema = z.object({
  name: z.string().min(1, "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"),
  gender: z.enum(["male", "female"], {
    errorMap: () => ({ message: "ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”" }),
  }),
  birthYear: z.number().int().min(1950).max(2010).nullable(),
  height: z.number().int().min(100).max(250).nullable(),
  occupation: z.string().max(50).nullable(),
  idealType: z.string().max(500).nullable(),
  photos: z.array(z.string().url()).max(3, "ì‚¬ì§„ì€ ìµœëŒ€ 3ì¥ê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤"),
});

export type CreateProfileInput = z.infer<typeof createProfileSchema>;
```

### ë™ì  OG ë©”íƒ€ íƒœê·¸

ê° í˜ì´ì§€ì—ì„œ `generateMetadata` í•¨ìˆ˜ë¡œ ë™ì  ë©”íƒ€ íƒœê·¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```typescript
// app/[locale]/rooms/[slug]/page.tsx
export async function generateMetadata({ params }: RoomPageProps): Promise<Metadata> {
  const { slug } = await params;
  const room = await getRoom(slug);

  if (!room) {
    return { title: "ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" };
  }

  const profileList = await getProfilesByRoom(room.id);
  const description = `${room.name} - ${profileList.length}ëª…ì˜ í”„ë¡œí•„ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;

  return {
    title: room.name,
    description,
    openGraph: {
      title: room.name,
      description,
      type: "website",
      images: [{ url: "/og_image.png", width: 1200, height: 630 }],
    },
  };
}
```

---

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
friend-intro-rooms/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ [locale]/
â”‚   â”‚   â”œâ”€â”€ page.tsx              # ë©”ì¸ í˜ì´ì§€
â”‚   â”‚   â”œâ”€â”€ login/page.tsx        # ë¡œê·¸ì¸
â”‚   â”‚   â”œâ”€â”€ my/page.tsx           # ë§ˆì´ í˜ì´ì§€
â”‚   â”‚   â””â”€â”€ rooms/
â”‚   â”‚       â”œâ”€â”€ new/page.tsx      # ë°© ìƒì„±
â”‚   â”‚       â””â”€â”€ [slug]/
â”‚   â”‚           â”œâ”€â”€ page.tsx      # ë°© ìƒì„¸
â”‚   â”‚           â”œâ”€â”€ register/     # í”„ë¡œí•„ ë“±ë¡
â”‚   â”‚           â””â”€â”€ admin/        # ê´€ë¦¬ì
â”‚   â””â”€â”€ auth/callback/route.ts    # OAuth ì½œë°±
â”œâ”€â”€ actions/                      # Server Actions
â”‚   â”œâ”€â”€ auth.ts
â”‚   â”œâ”€â”€ rooms.ts
â”‚   â”œâ”€â”€ profiles.ts
â”‚   â””â”€â”€ images.ts
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ schema.ts                 # Drizzle ìŠ¤í‚¤ë§ˆ
â”‚   â””â”€â”€ index.ts                  # DB í´ë¼ì´ì–¸íŠ¸
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ cache/                    # ìºì‹œ í•¨ìˆ˜
â”‚   â”œâ”€â”€ supabase/                 # Supabase í´ë¼ì´ì–¸íŠ¸
â”‚   â””â”€â”€ validations/              # Zod ìŠ¤í‚¤ë§ˆ
â”œâ”€â”€ i18n/                         # ë‹¤êµ­ì–´ ì„¤ì •
â”œâ”€â”€ messages/                     # ë²ˆì—­ íŒŒì¼
â”‚   â”œâ”€â”€ ko.json
â”‚   â””â”€â”€ en.json
â””â”€â”€ drizzle/                      # ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼
```

---

## íš¨ê³¼

| í•­ëª© | ê²°ê³¼ |
|---|---|
| API ì„œë²„ | ë¶ˆí•„ìš” (Server Actionsë¡œ ëŒ€ì²´) |
| íƒ€ì… ì•ˆì „ì„± | Drizzle + Zodë¡œ E2E íƒ€ì… ë³´ì¥ |
| ë³´ì•ˆ | RLS + ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ì¤‘ ê²€ì¦ |
| ì„±ëŠ¥ | ìºì‹± ë ˆì´ì–´ë¡œ DB ë¶€í•˜ ê°ì†Œ |
| ë‹¤êµ­ì–´ | IP ê¸°ë°˜ ìë™ ê°ì§€ + ìˆ˜ë™ ì „í™˜ |

Server Actionsì™€ ì„œë²„ ì»´í¬ë„ŒíŠ¸ ì¡°í•©ìœ¼ë¡œ ë³„ë„ API ì„œë²„ ì—†ì´ í’€ìŠ¤íƒ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. Drizzle ORMì€ Prismaë³´ë‹¤ ê°€ë³ê³  TypeScript ì¹œí™”ì ì´ì–´ì„œ ê°œë°œ ê²½í—˜ì´ ì¢‹ì•˜ìŠµë‹ˆë‹¤. Supabase RLSëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì¤€ ë³´ì•ˆì„ ì œê³µí•´ì„œ ì‹¤ìˆ˜ë¡œ ê¶Œí•œ ê²€ì‚¬ë¥¼ ëˆ„ë½í•´ë„ ì•ˆì „í•©ë‹ˆë‹¤.

## ë§ˆì¹˜ë©°

ì´ í”„ë¡œì íŠ¸ëŠ” Next.js App Routerì˜ ìƒˆë¡œìš´ íŒ¨í„´ë“¤ì„ ì‹¤í—˜í•˜ëŠ” ì¢‹ì€ ê¸°íšŒì˜€ìŠµë‹ˆë‹¤. ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§ì ‘ DBë¥¼ ì¡°íšŒí•˜ê³ , Server Actionsë¡œ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ëŠ” ë°©ì‹ì€ ê¸°ì¡´ API Routes ë°©ì‹ë³´ë‹¤ ì½”ë“œëŸ‰ì´ ì¤„ê³  íƒ€ì… ì•ˆì „ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤. Supabaseì™€ Drizzle ì¡°í•©ë„ ê´€ë¦¬í˜• ì„œë¹„ìŠ¤ì˜ í¸ë¦¬í•¨ê³¼ ORMì˜ íƒ€ì… ì•ˆì „ì„±ì„ ëª¨ë‘ ëˆ„ë¦´ ìˆ˜ ìˆì–´ì„œ ë§Œì¡±ìŠ¤ëŸ¬ì› ìŠµë‹ˆë‹¤.
